<!--
 *  GitHub Code Location: https://github.com/Encore-DigitalServices/CodeSnippets-Leaderboard-Template
 *  Name:                 Engagement Leaderboard
 *  Date:                 2022-10-28 - 1100 PDT
 *  Contributor(s):       Edisson F, Kenneth T
 *  Chime Version(s):     v6.11.0 ~ v6.14+
 *  Verified to work with:
                          - [Browser] - [Resolution]: 
                          - Chrome Inspector - iPhone 5/SE: YES - almost  LANDSCAPE AND PORTRAIT
                          - Chrome Inspector - iPad:        YES           LANDSCAPE AND PORTRAIT
                          - Ultrawide above -  1440 x 2560: YES           LANDSCAPE AND PORTRAIT
 * Accessibility:         - screenreader tested? Once, could use another one
                          - Aria?                Possibly tested
 * Description:
                          Custom Leaderboard, with static point allocation table.
                          Row gets highlighted if it is the user.
-->
<style>
  /*===============================================*/
  /* ==== CSS Leaderboard Design - START ===== */

  /*****
 *  GitHub Code Location: https://github.com/Encore-DigitalServices/Chime-Designs/blob/main/Leaderboards/Gabriel/Leaderboard-1.css
 *  Name:                 Leaderboard PCMA Design
 *  Last Updated:         2022-11-24 (13:24 EST)
 *  Contributor(s):       Gabriel R
 *  Chime Version(s):     v6.14+
 *  Verified to work with:
                          - Browser - Resolution: 
                          - Chrome Inspector - iPhone 5/SE: Landscape - VERIFIED YES
                          - Chrome Inspector - iPhone 5/SE: Portrait - VERIFIED YES
                          - Chrome Inspector - iPad:  Landscape - VERIFIED YES
                          - Chrome Inspector - iPad:  Portrait - VERIFIED YES
                          - Ultrawide above - 1440 x 2560: VERIFIED YES
 * Accessibility:         - screenreader tested? YES
                          - Aria?
 * Description:
		          Spacing between names and bright colours. Header is enlarged. Collapsible menu has been added.
 */

  .leaderboard-container.content-block {
    background-color: #373c49;
  }

  .leaderboard-container h2,
  .leaderboard-container {
    color: white;
  }

  .leaderboard-container tr {
    background: linear-gradient(0deg, rgba(250, 104, 85, 1) 0%, rgba(194, 68, 72, 1) 100%);
  }

  .codesnippets .engagement.leaderboard.wrapper.scrollable table {
    border: none !important;
  }

  tr.bg-primary {
    background: #fa6855;
  }

  .table,
  table {
    border-collapse: collapse !important;
  }

  /* Star Badges */
  .ua-desktop .yourscore-badges {
    font-size: 28px;
    text-align: center;
  }

  .yourscore-badges.text-primary {
    color: gold;
  }

  .yourscore-text,
  .yourscore-text .text-primary {
    color: white;
    text-align: center;
  }

  @media only screen and (min-width: 1000px) and (min-aspect-ratio: 9 / 16) and (max-aspect-ratio: 10 / 16) {
    .yourscore-container.content-block {
      display: none;
    }
  }

  .yourscore-container.content-block {
    background-color: #00000000 !important;
    background-image: linear-gradient(270deg, #444, #222a);
    border: unset;
    border-radius: unset;
    box-shadow: -1px 1px 8px 1px rgb(0 0 0 / 25%);
  }

  /* Add divider between activities and points */
  .codesnippets.engagement.leaderboard.wrapper.scrollable .leaderboard-container.content-block table td:not(:first-of-type) {
    border-left: none;
  }

  .leaderboard-container.content-block .table>thead>tr>th,
  .leaderboard-container.content-block .table>thead>tr>td,
  .leaderboard-container.content-block .table>tbody>tr>th,
  .leaderboard-container.content-block .table>tbody>tr>td,
  .leaderboard-container.content-block .table>tfoot>tr>th,
  .leaderboard-container.content-block .table>tfoot>tr>td {
    border-bottom: 6px solid #fff0;
    font-size: 240%;
    font-weight: 900;
    padding-top: 30px;
    padding-bottom: 30px;
  }

  h2 {
    font-size: 55px;
  }

  /* How to get more points dropdown arrow animation */
  .collapsible.force-click.active>i {
    -ms-filter: "progid:DXImageTransform.Microsoft.BasicImage(rotation=2)";
    -webkit-transform: rotate(-180deg);
    -ms-transform: rotate(-180deg);
    transform: rotate(-180deg);
    transition: all .1s ease-in;
  }

  @media only screen and (max-width: 768px) {

    .leaderboard-container.content-block .table>thead>tr>th,
    .leaderboard-container.content-block .table>thead>tr>td,
    .leaderboard-container.content-block .table>tbody>tr>th,
    .leaderboard-container.content-block .table>tbody>tr>td,
    .leaderboard-container.content-block .table>tfoot>tr>th,
    .leaderboard-container.content-block .table>tfoot>tr>td {
      border-bottom: 6px solid #fff0;
      font-size: 90% !important;
      font-weight: 900;
      font-weight: 900;
      padding-top: 30px;
      padding-bottom: 30px;
    }

    .engagement-container.content-block {
      font-size: 70% !important;
    }

    h2 {
      font-size: 150% !important;
    }
  }

  /*==================================================*/
  /* PRIMARY LEADERBOARD CHANGES - RANK,NAME & POINTS */

  td.leaderboard-rank {
    background-color: #fff3d5;
    color: black;
  }

  tr.rank-1 td.leaderboard-rank {
    background-color: gold;
    color: #000000;
  }

  tr.rank-2 td.leaderboard-rank {
    background-color: #c3af7e;
    color: #000000;
  }

  tr.rank-3 td.leaderboard-rank {
    background-color: #db9954;
    color: #000000;
  }

  .leaderboard-container tr {
    background-color: #00000000 !important;
    background-image: linear-gradient(270deg, #444, #222a);
    border: unset;
    border-radius: unset;
    box-shadow: -1px 1px 8px 1px rgb(0 0 0 / 25%);
  }

  tr.bg-primary .leaderboard-name,
  tr.bg-primary .leaderboard-points {
    background-color: #222222;
  }

  .leaderboard-container.content-block .table .leaderboard-name,
  th#leaderboard-name-title {
    padding-left: 40px;
  }

  /* PRIMARY LEADERBOARD CHANGES - RANK,NAME & POINTS */
  /*==================================================*/

  /* Center Hero Bar Page/Module Titles with Page Container instead of Viewer Width */
  @media only screen and (min-width: 1200px) {
    .nav-maximized .header-container .page-title {
      padding-left: 160px;
    }
  }

  .nav-toggle:focus span,
  .nav-toggle:focus span:before,
  .nav-toggle:focus span:after {
    background-color: #446;
  }

  .nav-toggle.toggled span {
    background-color: transparent;
  }

  .ua-mobile .collapsible {
    background-color: #777;
    color: white;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: none;
    text-align: center;
    outline: none;
    font-size: 32px;
  }

  .ua-mobile .active.collapsible,
  .ua-mobile .collapsible:hover {
    background-color: #373c49;
    border: 1px solid #e6e6e6;
    border-bottom: none;
  }

  .ua-mobile .engagement-container.content-block {
    padding: 0 18px;
    display: none;
    overflow: auto;
    box-shadow: none;
    border-radius: unset;
  }

  .ua-mobile .engagement-container.content-block.mobile-collapsible {
    margin-top: 0px;
    padding: 20px;
    border-radius: 0px 0px 4px 4px;
    border: 1px solid #e6e6e6;
    border-top: none;
    box-shadow: 1px 1px 4pxrgba(0, 0, 0, 0.05);
  }

  button.collapsible.force-click {
    background-color: #000a;
    background-image: linear-gradient(-90deg, #000a, transparent, #111);
    color: white;
    font-weight: bold;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: unset;
    text-align: center;
    outline: none;
    margin-top: 15px;
    font-size: 150%;
  }

  .active.collapsible.force-click,
  .collapsible.force-click:hover {
    background-color: #000a;
    background-image: linear-gradient(-90deg, #000a, transparent, #111);
    color: white;
  }

  .engagement-container.content-block.mobile-collapsible.force-click {
    display: none;
    margin-top: 0px;
    padding: 20px;
    border-radius: 0 0 4px 4px;
    border-top: none;
    box-shadow: 1px 1px 4px rgb(0 0 0 / 5%);
  }

  .engagement.leaderboard.wrapper.scrollable .collapsible .fa {
    transition: all 0.3s ease-in-out;
  }

  .leaderboard-container.content-block {
    background: none !important;
    border: none;
    box-shadow: none;
    border-radius: unset;
  }

  .leaderboard-title {
    display: none;
  }

  .nav-minimized .tools {
    width: 100%;
  }

  .engagement-container.content-block h2,
  .engagement-container.content-block .row,
  .engagement-container.content-block {
    background-image: linear-gradient(90deg, #111, #333) !important;
    border: unset;
    border-radius: unset;
  }

  h2.engagement-title {
    text-align: center;
  }

  .codesnippets .engagement.leaderboard.wrapper.scrollable .leaderboard-container table thead th:first-of-type,
  .codesnippets .engagement.leaderboard.wrapper.scrollable .leaderboard-container table tbody td:first-of-type {
    width: 50px;
  }

  .codesnippets .engagement.leaderboard.wrapper.scrollable .engagement-container table thead th:nth-of-type(2),
  .codesnippets .engagement.leaderboard.wrapper.scrollable .engagement-container table tbody td:nth-of-type(2),
  .codesnippets .engagement.leaderboard.wrapper.scrollable .leaderboard-container table thead th:not(:nth-of-type(2)),
  .codesnippets .engagement.leaderboard.wrapper.scrollable .leaderboard-container table tbody td:not(:nth-of-type(2)) {
    text-align: center;
  }

  /* Easter Egg */
  img.easter-egg2 {
    width: 30px;
  }

  a.easter-position2 {
    position: relative;
    padding-left: 2px;
  }

  /* ===== CSS Leaderboard Design - END ====== */
  /*===============================================*/
</style>

<!-- Engagement Leaderboard - START -->
<section class="engagement leaderboard wrapper scrollable">
  <div class="container-fluid">
    <!-- Engagement Points Breakdown (Manual) -->
    <button type="button" class="collapsible force-click">How to earn Points! <i class="fa fa-angle-down"></i></button>
    <div class="engagement-container content-block mobile-collapsible force-click">
      <div class="row">
        <h2 class="engagement-title">Engagement Leaderboard</h2>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">Activity</th>
                <th scope="col">Points</th>
                <th scope="col">Type</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Find and Scan an AR-activated Poster with the Poster Scanner Module (posters located around the Convention Centre)</td>
                <td>300</td>
                <td>Per Poster (8 available)</td>
              </tr>
              <tr>
                <td>Find all AR-activated Posters and get Bonus</td>
                <td>300</td>
                <td>One Time</td>
              </tr>
              <tr>
                <td>Find and Scan a Host, Platinum, Gold or Silver Partner QR Code with the QR Scanner Module</td>
                <td>200</td>
                <td>Per Host, Platinum, Gold and Silver Partner (11 available)</td>
              </tr>
              <tr>
                <td>Find and Click on a <a class="easter-position2" href="Forms?id=63&isDialog=true&dialog=true&update_db_record=true&clear_on_submit=false&notification_on_submit=false&icon=&modalSettings[title]=null&modalSettings[closeButton]=false"><img class="easter-egg2" src="https://pcma-cic2022.can.chime.live/app/assets/code/One%20Connector%20Easter%20Egg%20100x100.png" alt="Easter Egg" /></a></td>
                <td>100</td>
                <td>Per Found Icon (5 available)</td>
              </tr>
              <tr>
                <td>Session Feedback</td>
                <td>100</td>
                <td>Per Session Feedback submission</td>
              </tr>
              <tr>
                <td>Take/Upload a photo to the LiveSnap Gallery</td>
                <td>50</td>
                <td>Per Approved Photo</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Your Engagement Points (Automatic) -->
    <div class="yourscore-container content-block">
      <div class="row">
        <h2 class="yourscore-text">&nbsp;</h2>
        <div class="yourscore-badges text-primary"></div>
        <br />
        <p class="text-center"><em>If you have recently completed an activity that earns some points, please check back in a few minutes for it to be reflected.</em></p>
      </div>
    </div>

    <!-- Leaderboard (Automatic) -->
    <div class="leaderboard-container content-block">
      <div class="row">
        <h2 class="leaderboard-title">Leaderboard</h2>
      </div>
      <div class="row">
        <div class="col-xs-12">
          <table class="table">
            <thead>
              <tr>
                <th id="leaderboard-ranking-title" scope="col">Ranking</th>
                <th id="leaderboard-name-title" scope="col">Name</th>
                <th id="leaderboard-points-title" scope="col">Points</th>
              </tr>
            </thead>
            <tbody>
              <tr class="leaderboard-template">
                <td class="leaderboard-rank">&nbsp;</td>
                <td class="leaderboard-name">&nbsp;</td>
                <td class="leaderboard-points">&nbsp;</td>
              </tr>
              <tr class="leaderboard-empty">
                <td colspan="3"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</section>
<script>
  // Settings
  var leaderboardAmount = 25;

  var chimeVersion = null;
  var appCms = "";
  async function getChimeVersion() {
    if (chimeVersion) return chimeVersion;
    const appVersion = (await app.getAppVersionInfo()).split(".");
    chimeVersion = {
      major: parseInt(appVersion[0]),
      minor: parseInt(appVersion[1]),
      patch: parseInt(appVersion[2]),
    };
    return chimeVersion;
  }

  async function cmsApp() {
    if (appCms) return appCms;
    const c = await getChimeVersion();
    appCms = c.major <= 6 && c.minor <= 13 ? "cms" : "app";
    return appCms;
  }

  // Localisation
  setTimeout(() => {
    $(".leaderboard-container .leaderboard-title").text(
      localisation.get("engagement_leaderboard")
    );
    $(".engagement-container .engagement-title").text(
      localisation.get("engagement")
    );
  }, 150);

  (async () => {
    // Leaderboard
    ajax(`/${await cmsApp()}/services/gameification.asmx/leaderboard`, {
      top: leaderboardAmount,
    }).then((l) => {
      const $leaderboardBody = $(".leaderboard-container table tbody");
      const $leaderboardTemplate = $(".leaderboard-template", $leaderboardBody);
      if (Array.isArray(l.leaderboard) && l.leaderboard.length > 0) {
        $("tr.leaderboard-empty").remove();
        for (let pos of l.leaderboard) {
          let numRank = pos.position.replace("=", "");
          let rowClass = `rank-${numRank}`;
          if (pos.id === user.id) {
            rowClass += " bg-primary";
          }
          $leaderboardTemplate
            .clone()
            .removeClass("leaderboard-template")
            .addClass(rowClass)
            .find(".leaderboard-rank")
            .text(pos.position)
            .attr("data-rank", numRank)
            .data("rank", numRank)
            .end()
            .find(".leaderboard-name")
            .text(`${pos.firstName} ${pos.lastName}`)
            .end()
            .find(".leaderboard-points")
            .text(pos.points)
            .end()
            .appendTo($leaderboardBody);
        }
      } else {
        $("tr.leaderboard-empty td").html(
          `<em>${localisation.get("engagement_leaderboard_loading")}</em>`
        );
      }

      $leaderboardTemplate.remove();
      pageModules[0].updateScrollers();
    });

    // Your score and star badge generation
    ajax(`/${await cmsApp()}/services/user.asmx/points`).then((ys) => {
      $(".yourscore-container .yourscore-text")
        .text(`${localisation.get("engagement_score")}: `)
        .append($("<span>").addClass("text-primary").text(ys.points));
      for (let i = 0; i < ys.badges; i++) {
        $(".yourscore-container .yourscore-badges")
          .append('<i class="fa fa-star" aria-hidden="true">&nbsp;</i>')
          .attr({
            title: `Badge Count: ${ys.badges}`,
            "aria-label": `Badge Count: ${ys.badges}`,
          });
      }
      pageModules[0].updateScrollers();
    });
  })();

  // Collapsible Menu
  var coll = document.getElementsByClassName("collapsible");
  var i;

  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
      pageModules[0].updateScrollers();
    });
  }
</script>
<!-- Engagement Leaderboard - END -->
